name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  statuses: write

env:
  REVIEW_EVENT: COMMENT
  REVIEW_CLI_BIN: claude
  REVIEW_CLI_ARGS: --print
  SYSTEM_PROMPT: |
    Review this patch like a thoughtful senior engineer on the MFC (Molt Fighting Championship) project.

    Context: MFC is a Next.js 16 / TypeScript / Prisma / Solana prediction market exchange.
    Read CLAUDE.md at the repo root for full project context.

    Prioritize:
    1. Correctness — logic errors, race conditions, broken state transitions
    2. Security — auth bypass, missing requireAuth(), exposed secrets, SQL injection, XSS
    3. MFC conventions:
       - All auth-required API routes MUST call requireAuth() from lib/auth-guard.ts
       - All API routes MUST use ensureUser() to derive userId from session (never from request body/params)
       - No border-radius anywhere (pixel-art brand requirement)
       - No raw fetch() in components — use lib/api-client.ts
       - All API inputs MUST be validated with zod schemas from lib/validations.ts
       - Credit operations MUST use fetchCredits() for server-sync (no blind credits + amount)
    4. Performance — memory leaks, missing cleanup, unbounded loops
    5. Readability — clear naming, reasonable complexity

    Be concise and constructive. Praise good changes. Group related issues.
    If CLAUDE.md exists, verify the code complies with documented patterns.

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: ai-pr-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Claude Code
        run: |
          set -euo pipefail
          echo "Installing Claude Code via npm..."
          npm install -g @anthropic-ai/claude-code
          command -v claude >/dev/null 2>&1 || { echo "claude not found after install" >&2; exit 1; }
          claude --version || true

      - name: Gather PR context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR="${{ github.event.pull_request.number }}"
          SHA="${{ github.event.pull_request.head.sha }}"
          echo "PR=$PR" >> "$GITHUB_ENV"
          echo "SHA=$SHA" >> "$GITHUB_ENV"

          gh pr view "$PR" --repo "${{ github.repository }}" --json number,title,body,author,baseRefName,headRefName,url > pr.json
          gh pr diff "$PR" --repo "${{ github.repository }}" --patch > diff.patch

      - name: Run AI review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          if [ -n "${ANTHROPIC_API_KEY:-}" ]; then echo "::add-mask::${ANTHROPIC_API_KEY}"; fi

          INSTRUCTION=$(cat <<'EOF'
          You are performing a single-pass PR review for the MFC project.

          Inputs:
          - You will receive a unified diff (the PR patch) via stdin.
          - Comment only on changed/added lines; avoid spam.

          Output format - XML with this exact structure:

          <review>
            <summary>Overall assessment in 2-3 sentences. Focus on correctness, security, and MFC conventions.</summary>
            <comments>
              <comment>
                <file>path/to/file.ext</file>
                <line>123</line>
                <body>Your comment about this specific line</body>
              </comment>
            </comments>
            <status>
              <state>success</state>
              <description>Brief reason (under 120 chars)</description>
            </status>
          </review>
          EOF
          )

          echo "Running AI review..."
          echo "Diff size: $(wc -c < diff.patch) bytes"

          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."

            if cat diff.patch | timeout 300 "$REVIEW_CLI_BIN" $REVIEW_CLI_ARGS "${SYSTEM_PROMPT}

          ${INSTRUCTION}" > ai_output.xml; then
              if grep -q "<review>" ai_output.xml && grep -q "<summary>" ai_output.xml && grep -q "</review>" ai_output.xml; then
                echo "Valid XML review received"
                break
              else
                echo "Invalid XML received, retrying..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
              fi
            else
              echo "AI call failed, retrying..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 5
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "All retry attempts failed, creating fallback response"
            cat > ai_output.xml <<'FALLBACK'
          <review>
            <summary>AI review could not be completed after multiple attempts.</summary>
            <comments></comments>
            <status>
              <state>success</state>
              <description>AI Review fallback — manual review required</description>
            </status>
          </review>
          FALLBACK
          fi

          echo "AI review completed"

          node -e "
          const fs = require('fs');
          try {
            const xmlText = fs.readFileSync('ai_output.xml', 'utf8');

            const summaryMatch = xmlText.match(/<summary>([\s\S]*?)<\/summary>/);
            const summary = summaryMatch ? summaryMatch[1].trim() : 'No summary found';
            fs.writeFileSync('summary.txt', summary);

            const stateMatch = xmlText.match(/<state>([\s\S]*?)<\/state>/);
            const state = stateMatch ? stateMatch[1].trim() : 'success';
            fs.writeFileSync('state.txt', state);

            const descMatch = xmlText.match(/<description>([\s\S]*?)<\/description>/);
            const desc = descMatch ? descMatch[1].trim() : 'AI Review completed';
            fs.writeFileSync('description.txt', desc);
          } catch (error) {
            fs.writeFileSync('summary.txt', 'XML parsing failed');
            fs.writeFileSync('state.txt', 'success');
            fs.writeFileSync('description.txt', 'AI Review completed');
          }
          "

          echo "## AI Review Summary" > review.md
          cat summary.txt >> review.md

          echo "[]" > comments.json
          if grep -q "<comment>" ai_output.xml; then
            node -e "
            const fs = require('fs');
            try {
              const xmlText = fs.readFileSync('ai_output.xml', 'utf8');
              const comments = [];
              const commentBlocks = xmlText.match(/<comment>[\s\S]*?<\/comment>/g) || [];
              for (const block of commentBlocks) {
                const fileMatch = block.match(/<file>(.*?)<\/file>/);
                const lineMatch = block.match(/<line>(.*?)<\/line>/);
                const bodyMatch = block.match(/<body>([\s\S]*?)<\/body>/);
                if (fileMatch && lineMatch && bodyMatch) {
                  comments.push({
                    path: fileMatch[1].trim(),
                    line: parseInt(lineMatch[1].trim()),
                    side: 'RIGHT',
                    body: bodyMatch[1].trim()
                  });
                }
              }
              fs.writeFileSync('comments.json', JSON.stringify(comments));
            } catch (error) {
              fs.writeFileSync('comments.json', '[]');
            }
            "
          fi

          STATE=$(cat state.txt)
          DESC=$(cat description.txt)
          echo "{\"state\":\"$STATE\",\"description\":\"$DESC\"}" > status.json

      - name: Post PR review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          jq -n \
            --arg event "${REVIEW_EVENT}" \
            --arg body "$(cat review.md)" \
            --argjson comments "$(cat comments.json)" \
            '{ event: $event, body: $body, comments: $comments }' > review_payload.json

          gh api \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            "repos/${{ github.repository }}/pulls/$PR/reviews" \
            --input review_payload.json

      - name: Set commit status
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -f status.json ]; then
            echo '{"state":"success","description":"AI Review completed"}' > status.json
          fi
          STATE=$(jq -r '.state // "success"' status.json)
          DESC=$(jq -r '.description // "AI Review completed"' status.json)
          SHA="${{ github.event.pull_request.head.sha }}"
          gh api \
            -X POST \
            repos/${{ github.repository }}/statuses/${SHA} \
            -f state="$STATE" \
            -f context="AI PR Review" \
            -f description="$DESC"
